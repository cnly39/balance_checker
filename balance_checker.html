<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVM å†å²ä½™é¢æŸ¥è¯¢å·¥å…· (é˜²å°ä¼˜åŒ–ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <style>
        /* æ ·å¼ä¿æŒä¸å˜ */
        body { background-color: #0f172a; color: #e2e8f0; }
        .input-group label { display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.25rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;}
        .input-field { width: 100%; background-color: #1e293b; border: 1px solid #334155; color: white; padding: 0.5rem; border-radius: 0.375rem; outline: none; transition: border-color 0.2s; font-family: monospace; }
        .input-field:focus { border-color: #3b82f6; }
        .input-field:disabled { background-color: #0f172a; color: #64748b; border-color: #1e293b; cursor: not-allowed; }
        .btn { background-color: #3b82f6; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: background 0.2s; border: none; }
        .btn:hover { background-color: #2563eb; }
        .btn:disabled { background-color: #475569; cursor: not-allowed; opacity: 0.7; }
        .card { background-color: #1e293b; border-radius: 0.5rem; padding: 1.5rem; margin-top: 1.5rem; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .loading-pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="p-4 md:p-8 max-w-6xl mx-auto">

    <div class="mb-6 border-b border-slate-700 pb-4">
        <h1 class="text-3xl font-bold text-white mb-2 flex items-center gap-2">
            <span>ğŸš€</span> EVM å†å²ä½™é¢æŸ¥è¯¢å™¨ <span class="text-sm font-light text-green-400">ï¼ˆå·²ä¼˜åŒ–ï¼‰</span>
        </h1>
        <p class="text-slate-400 text-sm">æ”¯æŒè‡ªå®šä¹‰æ—¶é—´ã€é‡‡æ ·é—´éš”ä¸ RPC è¯·æ±‚é™æµ (é˜² 429 é”™è¯¯)</p>
    </div>

    <div class="bg-slate-800 p-6 rounded-lg border border-slate-700 shadow-xl space-y-4">
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="input-group md:col-span-2">
                <label>RPC URL (Archive Node)</label>
                <input type="text" id="rpcUrl" class="input-field" placeholder="https://..." value="https://eth.llamarpc.com">
            </div>
            <div class="input-group">
                <label>Chain ID</label>
                <input type="number" id="chainId" class="input-field" placeholder="è‡ªåŠ¨æ£€æµ‹" readonly>
            </div>
            <div class="input-group">
                <label class="text-yellow-400">RPC è¯·æ±‚å»¶è¿Ÿ (ms)</label>
                <input type="number" id="rpcDelay" class="input-field border-yellow-700/50 focus:border-yellow-500" value="200" min="0" step="100" title="æ¯æŸ¥è¯¢ä¸€æ¬¡æš‚åœçš„æ—¶é—´ï¼Œé˜²æ­¢èŠ‚ç‚¹å°é”">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="input-group">
                <label>é’±åŒ…åœ°å€ (Wallet)</label>
                <input type="text" id="walletAddress" class="input-field" placeholder="0x..." value="">
            </div>
            <div class="input-group">
                <label>ä»£å¸åˆçº¦ (Token Address)</label>
                <input type="text" id="tokenAddress" class="input-field" placeholder="ç•™ç©ºæŸ¥è¯¢åŸç”Ÿä»£å¸ (ETH/BNB...)">
            </div>
        </div>
        
        <div class="input-group border-t border-slate-700 pt-4">
            <label class="text-slate-300 font-bold mb-3 text-base">æ—¶é—´èŒƒå›´é¢„è®¾</label>
            <div class="flex flex-wrap gap-4" id="timeframeSelector">
                <label class="inline-flex items-center cursor-pointer bg-slate-700/50 px-3 py-2 rounded hover:bg-slate-700 transition">
                    <input type="radio" class="form-radio text-blue-600 w-4 h-4" name="timeframe" value="daily" checked onchange="toggleCustomDate(false)">
                    <span class="ml-2 text-sm">è¿‘7å¤© (æ¯æ—¥)</span>
                </label>
                <label class="inline-flex items-center cursor-pointer bg-slate-700/50 px-3 py-2 rounded hover:bg-slate-700 transition">
                    <input type="radio" class="form-radio text-blue-600 w-4 h-4" name="timeframe" value="weekly" onchange="toggleCustomDate(false)">
                    <span class="ml-2 text-sm">è¿‘4å‘¨ (æ¯å‘¨)</span>
                </label>
                <label class="inline-flex items-center cursor-pointer bg-slate-700/50 px-3 py-2 rounded hover:bg-slate-700 transition">
                    <input type="radio" class="form-radio text-blue-600 w-4 h-4" name="timeframe" value="monthly" onchange="toggleCustomDate(false)">
                    <span class="ml-2 text-sm">è¿‘6æœˆ (æ¯æœˆ)</span>
                </label>
                <label class="inline-flex items-center cursor-pointer bg-blue-900/30 px-3 py-2 rounded border border-blue-800 hover:bg-blue-900/50 transition">
                    <input type="radio" class="form-radio text-blue-600 w-4 h-4" name="timeframe" value="custom" onchange="toggleCustomDate(true)">
                    <span class="ml-2 text-sm font-semibold text-blue-300">è‡ªå®šä¹‰èŒƒå›´ & é‡‡æ ·</span>
                </label>
            </div>
        </div>

        <div id="customDatePanel" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4 bg-slate-900/80 p-4 rounded border border-blue-500/30">
            <div class="input-group">
                <label>å¼€å§‹æ—¶é—´</label>
                <input type="datetime-local" id="customStart" class="input-field">
            </div>
            <div class="input-group">
                <label>ç»“æŸæ—¶é—´</label>
                <input type="datetime-local" id="customEnd" class="input-field">
            </div>
            <div class="input-group">
                <label>é‡‡æ ·é—´éš” (Step)</label>
                <div class="flex space-x-2">
                    <input type="number" id="intervalValue" class="input-field w-2/3" value="1" min="1">
                    <select id="intervalUnit" class="input-field w-1/3 text-xs">
                        <option value="3600">å°æ—¶</option>
                        <option value="86400" selected>å¤©</option>
                        <option value="604800">å‘¨</option>
                    </select>
                </div>
            </div>
            <div class="md:col-span-3 text-xs text-slate-400 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                é‡‡æ ·ç‚¹å»ºè®®æ§åˆ¶åœ¨ 50 ä»¥å†…ï¼Œå¦åˆ™æŸ¥è¯¢æ—¶é—´è¿‡é•¿ã€‚
            </div>
        </div>

        <div>
            <button id="queryBtn" class="btn w-full py-3 text-lg shadow-lg shadow-blue-900/20 flex justify-center items-center gap-2" onclick="startQuery()">
                <span>ğŸš€ å¼€å§‹åˆ†æ</span>
            </button>
        </div>
    </div>

    <div id="statusArea" class="mt-4 hidden p-4 rounded text-sm font-mono transition-all duration-300 border bg-slate-800"></div>

    <div id="resultArea" class="hidden space-y-6">
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <span class="w-2 h-6 bg-blue-500 rounded-sm"></span>
                    èµ„é‡‘æ›²çº¿
                </h3>
            </div>
            <div class="relative h-80 w-full">
                <canvas id="balanceChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h3 class="text-xl font-bold mb-4 text-white flex items-center gap-2">
                <span class="w-2 h-6 bg-green-500 rounded-sm"></span>
                å†å²å¿«ç…§è¯¦æƒ…
            </h3>
            <div class="overflow-x-auto max-h-[500px] rounded-lg border border-slate-700">
                <table class="w-full text-left text-sm text-slate-300">
                    <thead class="bg-slate-700 text-slate-100 sticky top-0 z-10">
                        <tr>
                            <th class="p-4 font-semibold">æ—¥æœŸ/æ—¶é—´</th>
                            <th class="p-4 font-semibold">åŒºå—é«˜åº¦ (Est.)</th>
                            <th class="p-4 font-semibold text-right">ä½™é¢</th>
                        </tr>
                    </thead>
                    <tbody id="resultTableBody" class="divide-y divide-slate-700 bg-slate-800/50"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- RPC ç¼“å­˜å˜é‡ ---
        let cachedProvider = null;
        let cachedRpcUrl = '';
        let cachedNetwork = null;
        // ------------------

        // åˆå§‹åŒ–
        window.onload = function() {
            const now = new Date();
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const formatForInput = (date) => date.toISOString().slice(0, 16);
            document.getElementById('customEnd').value = formatForInput(now);
            document.getElementById('customStart').value = formatForInput(sevenDaysAgo);
        };

        function toggleCustomDate(show) {
            const panel = document.getElementById('customDatePanel');
            show ? (panel.classList.remove('hidden'), panel.classList.add('grid')) 
                 : (panel.classList.add('hidden'), panel.classList.remove('grid'));
        }

        const ERC20_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)"
        ];

        let chartInstance = null;

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function log(msg, type = 'info') {
            const statusDiv = document.getElementById('statusArea');
            statusDiv.classList.remove('hidden', 'bg-red-900/20', 'text-red-300', 'border-red-800', 'bg-blue-900/20', 'text-blue-300', 'border-blue-800', 'bg-green-900/20', 'text-green-300', 'border-green-800', 'loading-pulse');
            
            if (type === 'error') {
                statusDiv.classList.add('bg-red-900/20', 'text-red-300', 'border-red-800');
            } else if (type === 'success') {
                statusDiv.classList.add('bg-green-900/20', 'text-green-300', 'border-green-800');
            } else if (type === 'loading') {
                statusDiv.classList.add('bg-blue-900/20', 'text-blue-300', 'border-blue-800', 'loading-pulse');
            } else {
                statusDiv.classList.add('bg-blue-900/20', 'text-blue-300', 'border-blue-800');
            }
            statusDiv.innerHTML = msg;
        }

        async function startQuery() {
            const rpcUrl = document.getElementById('rpcUrl').value;
            const walletAddr = document.getElementById('walletAddress').value;
            const tokenAddr = document.getElementById('tokenAddress').value;
            const timeframe = document.querySelector('input[name="timeframe"]:checked').value;
            const rpcDelay = parseInt(document.getElementById('rpcDelay').value) || 0;
            
            if (!rpcUrl || !walletAddr) {
                log("âš ï¸ è¯·å¡«å†™å®Œæ•´çš„ RPC URL å’Œ é’±åŒ…åœ°å€", "error");
                return;
            }

            const btn = document.getElementById('queryBtn');
            btn.disabled = true;
            btn.innerHTML = `<span class="animate-spin">â†»</span> æ­£åœ¨è¿æ¥...`;
            document.getElementById('resultArea').classList.add('hidden');
            
            let provider;
            
            try {
                // --- 1. ä¼˜åŒ–: RPC è¿æ¥å’Œ Chain ID è·å– ---
                if (rpcUrl !== cachedRpcUrl || !cachedProvider) {
                    // RPC åœ°å€æ”¹å˜æˆ–ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œé‡æ–°åˆ›å»º Provider
                    log("ğŸ”Œ æ­£åœ¨è¿æ¥æ–°çš„ RPC èŠ‚ç‚¹å¹¶è·å– Chain ID...", "loading");
                    provider = new ethers.providers.JsonRpcProvider(rpcUrl);
                    const network = await provider.getNetwork();
                    
                    // æ›´æ–°ç¼“å­˜
                    cachedProvider = provider;
                    cachedRpcUrl = rpcUrl;
                    cachedNetwork = network;
                } else {
                    // RPC åœ°å€æœªå˜ï¼Œä½¿ç”¨ç¼“å­˜
                    provider = cachedProvider;
                    log("ğŸ”Œ ä½¿ç”¨ç¼“å­˜çš„ RPC è¿æ¥ (Chain ID: " + cachedNetwork.chainId + ")ã€‚", "info");
                }
                
                document.getElementById('chainId').value = cachedNetwork.chainId;
                
                // --- 2. è·å–åŒºå—æ—¶é—´å‚æ•° ---
                log("â±ï¸ åˆ†æå‡ºå—é€Ÿåº¦...", "loading");
                const currentBlock = await provider.getBlock('latest');
                const currentBlockNum = currentBlock.number;
                const currentTimestamp = currentBlock.timestamp;

                const lookbackCount = 2000; 
                const pastBlockNum = Math.max(0, currentBlockNum - lookbackCount);
                const pastBlock = await provider.getBlock(pastBlockNum);
                const avgBlockTime = (currentTimestamp - pastBlock.timestamp) / (currentBlockNum - pastBlockNum);
                
                // --- 3. ç”Ÿæˆæ—¶é—´ç‚¹ ---
                let points = [];
                if (timeframe === 'custom') {
                    // ... (è‡ªå®šä¹‰æ—¶é—´ç‚¹ç”Ÿæˆé€»è¾‘ä¸å˜)
                    const startTs = new Date(document.getElementById('customStart').value).getTime() / 1000;
                    const endTs = new Date(document.getElementById('customEnd').value).getTime() / 1000;
                    const interval = parseInt(document.getElementById('intervalValue').value) * parseInt(document.getElementById('intervalUnit').value);

                    if (startTs >= endTs) throw new Error("å¼€å§‹æ—¶é—´å¿…é¡»æ—©äºç»“æŸæ—¶é—´");
                    for (let t = startTs; t <= endTs; t += interval) {
                        points.push({ timestamp: Math.floor(t), label: moment.unix(t).format("YYYY-MM-DD HH:mm") });
                    }
                    if (points[points.length-1].timestamp < Math.floor(endTs)) {
                        points.push({ timestamp: Math.floor(endTs), label: moment.unix(endTs).format("YYYY-MM-DD HH:mm") });
                    }
                } else {
                    // ... (é¢„è®¾æ—¶é—´ç‚¹ç”Ÿæˆé€»è¾‘ä¸å˜)
                    const nowM = moment();
                    const presets = {
                        'daily': { count: 7, unit: 'days', fmt: 'MM-DD' },
                        'weekly': { count: 4, unit: 'weeks', fmt: 'MM-DD (W)' },
                        'monthly': { count: 6, unit: 'months', fmt: 'YYYY-MM' }
                    };
                    const cfg = presets[timeframe];
                    for(let i=0; i<cfg.count; i++) {
                        let d = moment().subtract(i, cfg.unit);
                        points.push({ label: d.format(cfg.fmt), timestamp: d.unix() });
                    }
                    points.reverse();
                }

                // 4. å‡†å¤‡ä»£å¸ä¿¡æ¯
                let tokenContract = null;
                let decimals = 18;
                let symbol = "ETH/Native";

                if (tokenAddr) {
                    tokenContract = new ethers.Contract(tokenAddr, ERC20_ABI, provider);
                    try {
                        symbol = await tokenContract.symbol();
                        decimals = await tokenContract.decimals();
                    } catch (e) {
                        log(`âš ï¸ è¯»å–ä»£å¸ä¿¡æ¯å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤ç²¾åº¦ã€‚`, 'info');
                    }
                }

                // 5. ä¸²è¡ŒæŸ¥è¯¢
                log(`ğŸ” å‡†å¤‡æŸ¥è¯¢ ${points.length} ä¸ªæ—¶é—´ç‚¹ (RPC å»¶è¿Ÿ: ${rpcDelay}ms)...`, "loading");
                
                const results = [];
                
                for (let i = 0; i < points.length; i++) {
                    const point = points[i];
                    
                    const progressPercent = Math.round(((i + 1) / points.length) * 100);
                    btn.innerHTML = `<span class="animate-spin">â†»</span> æŸ¥è¯¢ä¸­ ${progressPercent}%`;

                    const timeDiff = currentTimestamp - point.timestamp;
                    let targetBlock = currentBlockNum;
                    
                    if (timeDiff > 0) {
                        targetBlock = Math.floor(currentBlockNum - (timeDiff / avgBlockTime));
                        if (targetBlock < 0) targetBlock = 0;
                    }

                    // è·å–ä½™é¢
                    let balanceFormatted = "0";
                    try {
                        let bal;
                        if (tokenAddr) {
                            bal = await tokenContract.balanceOf(walletAddr, { blockTag: targetBlock });
                        } else {
                            bal = await provider.getBalance(walletAddr, targetBlock);
                        }
                        balanceFormatted = ethers.utils.formatUnits(bal, decimals);
                    } catch (err) {
                        console.warn(`æŸ¥è¯¢å¤±è´¥ at block ${targetBlock}:`, err);
                        balanceFormatted = "Error"; 
                    }

                    results.push({
                        ...point,
                        block: targetBlock,
                        balance: balanceFormatted
                    });

                    log(`ğŸ“¥ [${i+1}/${points.length}] å·²è·å– ${point.label} ä½™é¢...`, "loading");

                    if (rpcDelay > 0 && i < points.length - 1) {
                        await sleep(rpcDelay);
                    }
                }

                renderResults(results, symbol);
                log(`âœ… æŸ¥è¯¢å®Œæˆ! æˆåŠŸè·å– ${results.length} ä¸ªå¿«ç…§ã€‚`, 'success');

            } catch (error) {
                console.error(error);
                log(`âŒ å‡ºé”™äº†: ${error.message || error}`, "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<span>ğŸš€ å¼€å§‹åˆ†æ</span>`;
            }
        }

        // --- renderResults å‡½æ•°ä¿æŒä¸å˜ ---

        function renderResults(data, symbol) {
            document.getElementById('resultArea').classList.remove('hidden');
            const tbody = document.getElementById('resultTableBody');
            tbody.innerHTML = '';

            const labels = [];
            const values = [];

            data.forEach(row => {
                const isError = row.balance === "Error";
                const displayBal = isError ? "---" : parseFloat(row.balance).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 4});
                
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-700/50 transition-colors";
                tr.innerHTML = `
                    <td class="p-4 border-b border-slate-700 font-mono text-slate-300">${row.label}</td>
                    <td class="p-4 border-b border-slate-700 text-slate-500 font-mono text-xs">#${row.block}</td>
                    <td class="p-4 border-b border-slate-700 text-right font-bold ${isError ? 'text-red-500' : 'text-green-400'}">${displayBal} ${isError ? '' : symbol}</td>
                `;
                tbody.appendChild(tr);

                if (!isError) {
                    labels.push(row.label);
                    values.push(parseFloat(row.balance));
                }
            });

            const ctx = document.getElementById('balanceChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${symbol} æŒä»“é‡`,
                        data: values,
                        borderColor: '#60a5fa',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointBackgroundColor: '#1e293b',
                        pointBorderColor: '#93c5fd',
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { labels: { color: '#cbd5e1' } },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#e2e8f0',
                            bodyColor: '#e2e8f0',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 10
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: '#334155', borderDash: [5, 5] },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 0 }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>