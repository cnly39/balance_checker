<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVM æ˜¾å¾®é•œ - å…¨ç±»å‹æ”¯æŒç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; }
        .input-group label { display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.35rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;}
        .input-field { width: 100%; background-color: #1e293b; border: 1px solid #334155; color: white; padding: 0.6rem; border-radius: 0.5rem; outline: none; transition: border-color 0.2s; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 0.9rem; }
        .input-field:focus { border-color: #3b82f6; ring: 2px solid #3b82f6; }
        .btn { background-color: #3b82f6; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
        .btn:hover { background-color: #2563eb; transform: translateY(-1px); }
        .btn:disabled { background-color: #475569; cursor: not-allowed; opacity: 0.7; transform: none; }
        .card { background-color: #1e293b; border-radius: 0.75rem; padding: 1.5rem; margin-top: 1.5rem; border: 1px solid #334155; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .preset-btn { transition: all 0.2s; border: 1px solid #334155; }
        .preset-active { background-color: #16a34a !important; border-color: #16a34a !important; color: white !important; }
        
        /* è¡¨æ ¼ä¼˜åŒ– */
        .col-time { min-width: 110px; }
        .col-block { min-width: 90px; }
        .col-val { word-break: break-all; font-family: 'Courier New', Courier, monospace; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="p-4 md:p-8 max-w-7xl mx-auto min-h-screen">

    <header class="mb-6 border-b border-slate-700 pb-4">
        <h1 class="text-3xl font-bold text-white mb-2 flex items-center gap-3">
            <span class="bg-blue-600 p-2 rounded-lg text-xl">ğŸ§¬</span>
            EVM æ˜¾å¾®é•œ (å…¨ç±»å‹æ”¯æŒ)
        </h1>
        <p class="text-slate-400 text-sm">
            æ”¯æŒï¼šå¤šé“¾æ•°æ® | åˆ†é’Ÿçº§é‡‡æ · | <span class="text-yellow-400 font-bold">æ•°å­—/åœ°å€/å­—ç¬¦ä¸²/å¸ƒå°”å€¼ æ··åˆå±•ç¤º</span>
        </p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-1 space-y-6">
            <div class="card mt-0 h-full border-t-4 border-t-blue-500">
                <h2 class="text-xl font-bold text-white mb-4">1. èŠ‚ç‚¹è¿æ¥</h2>
                <div class="space-y-4">
                    <div class="input-group">
                        <label>RPC URL</label>
                        <input type="text" id="rpcUrl" class="input-field" value="https://eth.llamarpc.com">
                    </div>
                    <div class="input-group">
                        <label>Chain ID</label>
                        <input type="number" id="chainId" class="input-field bg-slate-800 text-slate-400" placeholder="è‡ªåŠ¨æ£€æµ‹" readonly>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
            <div class="card mt-0 h-full border-t-4 border-t-purple-500">
                <h2 class="text-xl font-bold text-white mb-4">2. æŸ¥è¯¢ç›®æ ‡</h2>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-6">
                    <label class="cursor-pointer bg-slate-800 border border-green-600/50 p-3 rounded-lg hover:bg-slate-700 flex flex-col items-center justify-center text-center">
                        <input type="radio" name="queryMode" value="native" checked onchange="toggleMode()" class="mb-1 accent-green-500">
                        <span class="text-xs font-bold text-green-400">åŸç”Ÿ ETH</span>
                    </label>
                    <label class="cursor-pointer bg-slate-800 border border-purple-600/50 p-3 rounded-lg hover:bg-slate-700 flex flex-col items-center justify-center text-center">
                        <input type="radio" name="queryMode" value="manual" onchange="toggleMode()" class="mb-1 accent-purple-500">
                        <span class="text-xs font-bold text-purple-400">æ‰‹åŠ¨ ABI</span>
                    </label>
                    <label class="cursor-pointer bg-slate-800 border border-purple-600/50 p-3 rounded-lg hover:bg-slate-700 flex flex-col items-center justify-center text-center">
                        <input type="radio" name="queryMode" value="etherscan" onchange="toggleMode()" class="mb-1 accent-purple-500">
                        <span class="text-xs font-bold text-purple-400">Etherscan V2</span>
                    </label>
                    <label class="cursor-pointer bg-slate-800 border border-red-600/50 p-3 rounded-lg hover:bg-slate-700 flex flex-col items-center justify-center text-center">
                        <input type="radio" name="queryMode" value="hex" onchange="toggleMode()" class="mb-1 accent-red-500">
                        <span class="text-xs font-bold text-red-400">Hex Data</span>
                    </label>
                </div>

                <div class="input-group mb-4">
                    <label id="targetLabel">é’±åŒ…åœ°å€</label>
                    <input type="text" id="targetAddress" class="input-field" placeholder="0x...">
                </div>

                <div id="abiPanel" class="hidden space-y-3 border-t border-slate-700 pt-4">
                    <div id="manualAbiInput" class="hidden">
                        <label>JSON ABI</label>
                        <textarea id="abiText" rows="2" class="input-field text-xs font-mono" placeholder='["function owner() view returns (address)"]'></textarea>
                    </div>
                    <div id="etherscanInput" class="hidden input-group">
                        <label>API Key</label>
                        <input type="text" id="etherscanKey" class="input-field" placeholder="Etherscan API Key">
                    </div>
                    <button onclick="loadAbi()" class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-white rounded text-sm font-semibold">åŠ è½½ ABI</button>
                    <div id="methodSelectArea" class="hidden mt-4">
                        <div class="input-group">
                            <label class="text-purple-400">é€‰æ‹©æ–¹æ³•</label>
                            <select id="functionSelector" class="input-field" onchange="generateArgInputs(this.value)"></select>
                        </div>
                        <div id="dynamicArgs" class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2"></div>
                    </div>
                </div>

                <div id="hexPanel" class="hidden space-y-3 border-t border-slate-700 pt-4">
                    <div class="input-group">
                        <label class="text-red-400">Call Data (Hex)</label>
                        <input type="text" id="hexInput" class="input-field font-mono text-sm" placeholder="0x...">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
        
        <div class="lg:col-span-1">
            <div class="card mt-0 h-full border-t-4 border-t-yellow-500 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-white">3. è¾“å‡ºé…ç½®</h2>
                    <button onclick="addSeries()" class="text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded">+ æ·»åŠ æ•°æ®åˆ—</button>
                </div>
                
                <div id="outputReference" class="bg-slate-800 p-2 rounded mb-3 text-xs text-slate-400 font-mono hidden"></div>

                <div id="seriesContainer" class="flex-1 space-y-3 overflow-y-auto max-h-[300px] pr-1"></div>
                
                <div class="mt-2 text-xs text-slate-500">
                    <p>æç¤ºï¼š<br>
                    1. è·å–åœ°å€/å­—ç¬¦ä¸²: è¾“å…¥ <span class="text-yellow-300 font-mono">data[0]</span><br>
                    2. è·å–æ•°å€¼(å›¾è¡¨): è¾“å…¥ <span class="text-yellow-300 font-mono">data[0] / 1e18</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="card mt-0 h-full border-t-4 border-t-green-500">
                <h2 class="text-xl font-bold text-white mb-4">4. æ—¶é—´èŒƒå›´ä¸æ‰§è¡Œ</h2>
                <div class="space-y-4">
                    <div class="flex flex-wrap gap-2" id="presetGroup">
                        <button onclick="setTimePreset('hour')" data-type="hour" class="preset-btn px-3 py-1 bg-slate-800 rounded text-sm hover:bg-slate-700">â±ï¸ è¿‘1å°æ—¶</button>
                        <button onclick="setTimePreset('daily')" data-type="daily" class="preset-btn px-3 py-1 bg-slate-800 rounded text-sm hover:bg-slate-700">ğŸ“… è¿‘7å¤©</button>
                        <button onclick="setTimePreset('weekly')" data-type="weekly" class="preset-btn px-3 py-1 bg-slate-800 rounded text-sm hover:bg-slate-700">ğŸ—“ï¸ è¿‘4å‘¨</button>
                        <button onclick="setTimePreset('custom')" data-type="custom" class="preset-btn px-3 py-1 bg-slate-800 rounded text-sm border-dashed text-slate-400">ğŸ› ï¸ è‡ªå®šä¹‰</button>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-slate-900/50 p-4 rounded-lg">
                        <div class="input-group"><label>å¼€å§‹</label><input type="datetime-local" id="startTime" class="input-field" step="60" onchange="triggerCustom()"></div>
                        <div class="input-group"><label>ç»“æŸ</label><input type="datetime-local" id="endTime" class="input-field" step="60" onchange="triggerCustom()"></div>
                        <div class="input-group">
                            <label>é—´éš”</label>
                            <div class="flex gap-1">
                                <input type="number" id="stepValue" class="input-field w-14" value="1" min="1" onchange="triggerCustom()">
                                <select id="stepUnit" class="input-field flex-1 text-xs" onchange="triggerCustom()">
                                    <option value="60">åˆ†</option>
                                    <option value="3600">æ—¶</option>
                                    <option value="86400" selected>å¤©</option>
                                    <option value="604800">å‘¨</option>
                                </select>
                            </div>
                        </div>
                        <div class="input-group"><label class="text-yellow-500">å»¶è¿Ÿ(ms)</label><input type="number" id="rpcDelay" class="input-field" value="100"></div>
                    </div>

                    <button onclick="startAnalysis()" id="analyzeBtn" class="btn w-full text-lg shadow-lg">ğŸš€ å¼€å§‹åˆ†æ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="statusArea" class="hidden mt-4 p-3 rounded bg-slate-800 border border-slate-700 font-mono text-sm"></div>
    <div id="resultsArea" class="hidden mt-6 space-y-6">
        <div class="card border-0"><div class="h-96 w-full relative"><canvas id="mainChart"></canvas></div></div>
        <div class="card border-0">
            <h3 class="font-bold text-white mb-2">å†å²è®°å½• (å€’åº)</h3>
            <div class="overflow-x-auto max-h-[500px]">
                <table class="w-full text-left text-sm text-slate-300 table-fixed">
                    <thead id="tableHead" class="bg-slate-700 text-slate-100 sticky top-0 z-10"></thead>
                    <tbody id="resultTableBody" class="divide-y divide-slate-700 bg-slate-800/50"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let provider, contractInterface, selectedFunc, chartInstance, cachedRpc = "";
        let seriesCount = 0;
        const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];

        window.onload = () => {
            setTimePreset('daily');
            toggleMode();
            addSeries(true);
        };

        const toLocalISO = (d) => new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16);

        // --- Series Management ---
        function addSeries(isDefault = false) {
            seriesCount++;
            const id = `series-${seriesCount}`;
            const color = COLORS[(seriesCount - 1) % COLORS.length];
            const div = document.createElement('div');
            div.id = id;
            div.className = "bg-slate-900 p-3 rounded border border-slate-700 relative group";
            div.innerHTML = `
                <div class="flex gap-2 items-center mb-2">
                    <input type="checkbox" checked class="accent-blue-500 w-4 h-4 cursor-pointer" title="æ˜¾ç¤º/éšè—" id="chk-${id}">
                    <div class="w-3 h-3 rounded-full" style="background-color: ${color}"></div>
                    <input type="text" class="bg-transparent border-b border-slate-600 text-sm w-full focus:outline-none focus:border-blue-500 text-white" value="Col ${seriesCount}" placeholder="åç§°" id="name-${id}">
                    ${!isDefault ? `<button onclick="removeSeries('${id}')" class="text-slate-500 hover:text-red-400">âœ•</button>` : ''}
                </div>
                <div class="input-group">
                    <textarea id="expr-${id}" rows="1" class="w-full bg-slate-800 border border-slate-600 rounded p-1 text-xs font-mono text-yellow-300 focus:outline-none focus:border-yellow-500" placeholder="JSè¡¨è¾¾å¼">${isDefault ? 'data[0] / 1e18' : ''}</textarea>
                </div>
            `;
            document.getElementById('seriesContainer').appendChild(div);
        }

        function removeSeries(id) { document.getElementById(id).remove(); }

        function updateOutputReference(func) {
            const ref = document.getElementById('outputReference');
            if(!func || !func.outputs || func.outputs.length === 0) {
                ref.innerHTML = "æ— è¿”å›å€¼å®šä¹‰"; ref.classList.remove('hidden'); return;
            }
            let html = "<div class='font-bold mb-1 text-slate-300'>å˜é‡å‚è€ƒ:</div>";
            func.outputs.forEach((out, idx) => {
                const name = out.name || `result${idx}`;
                html += `<div><span class="text-blue-400">data[${idx}]</span>: ${name} <span class="text-slate-500">(${out.type})</span></div>`;
            });
            ref.innerHTML = html;
            ref.classList.remove('hidden');
        }

        // --- UI Logic ---
        function triggerCustom() { updatePresets('custom'); }
        function updatePresets(activeType) {
            document.querySelectorAll('.preset-btn').forEach(btn => {
                if(btn.dataset.type === activeType) btn.classList.add('preset-active');
                else btn.classList.remove('preset-active');
            });
        }
        function setTimePreset(type) {
            updatePresets(type);
            if(type === 'custom') return;
            const now = new Date();
            let start = new Date();
            let unit = 86400, val = 1;
            if(type === 'hour') { start.setHours(now.getHours()-1); unit=60; val=1; }
            else if(type === 'daily') { start.setDate(now.getDate()-7); unit=86400; }
            else if(type === 'weekly') { start.setDate(now.getDate()-28); unit=86400; }
            document.getElementById('endTime').value = toLocalISO(now);
            document.getElementById('startTime').value = toLocalISO(start);
            document.getElementById('stepUnit').value = unit;
            document.getElementById('stepValue').value = val;
        }

        function toggleMode() {
            const mode = document.querySelector('input[name="queryMode"]:checked').value;
            const targetLabel = document.getElementById('targetLabel');
            ['abiPanel','hexPanel','manualAbiInput','etherscanInput'].forEach(id => document.getElementById(id).classList.add('hidden'));

            if (mode === 'native') {
                targetLabel.textContent = "é’±åŒ…åœ°å€";
                targetLabel.className = "text-green-400 font-bold uppercase text-xs mb-1";
                document.getElementById('outputReference').innerHTML = "data: BigNumber (Wei)<br>ç¤ºä¾‹: data / 1e18";
                document.getElementById('outputReference').classList.remove('hidden');
            } else if (mode === 'hex') {
                targetLabel.textContent = "ç›®æ ‡åˆçº¦";
                targetLabel.className = "text-red-400 font-bold uppercase text-xs mb-1";
                document.getElementById('hexPanel').classList.remove('hidden');
                document.getElementById('outputReference').innerHTML = "data: Hex String / BigNumber";
                document.getElementById('outputReference').classList.remove('hidden');
            } else {
                targetLabel.textContent = "åˆçº¦åœ°å€";
                targetLabel.className = "text-purple-400 font-bold uppercase text-xs mb-1";
                document.getElementById('abiPanel').classList.remove('hidden');
                if(mode==='manual') document.getElementById('manualAbiInput').classList.remove('hidden');
                if(mode==='etherscan') document.getElementById('etherscanInput').classList.remove('hidden');
            }
        }

        function log(msg, type='info') {
            const el = document.getElementById('statusArea');
            el.classList.remove('hidden','text-red-400','text-blue-400');
            el.classList.add(type==='error'?'text-red-400':'text-blue-400');
            el.innerText = msg;
        }

        // --- Core Logic ---
        async function initProvider() {
            const url = document.getElementById('rpcUrl').value;
            if(url !== cachedRpc) {
                provider = new ethers.providers.JsonRpcProvider(url);
                const net = await provider.getNetwork();
                document.getElementById('chainId').value = net.chainId;
                cachedRpc = url;
            }
            return provider;
        }

        async function loadAbi() {
            try {
                await initProvider();
                const mode = document.querySelector('input[name="queryMode"]:checked').value;
                const addr = document.getElementById('targetAddress').value;
                let abiJson;

                if (mode === 'etherscan') {
                    const key = document.getElementById('etherscanKey').value;
                    const chainId = document.getElementById('chainId').value;
                    const res = await fetch(`https://api.etherscan.io/v2/api?chainid=${chainId}&module=contract&action=getabi&address=${addr}&apikey=${key}`);
                    const data = await res.json();
                    if(data.status !== "1") throw new Error(data.result);
                    abiJson = data.result;
                } else {
                    abiJson = document.getElementById('abiText').value;
                }

                contractInterface = new ethers.utils.Interface(abiJson);
                const sel = document.getElementById('functionSelector');
                sel.innerHTML = '<option value="">-- é€‰æ‹©æ–¹æ³• --</option>';
                Object.values(contractInterface.functions).forEach(f => {
                    if(['view','pure'].includes(f.stateMutability)) {
                        const opt = document.createElement('option');
                        opt.value = f.format(); opt.text = f.name;
                        sel.appendChild(opt);
                    }
                });
                document.getElementById('methodSelectArea').classList.remove('hidden');
            } catch(e) { log(e.message, 'error'); }
        }

        function generateArgInputs(sig) {
            const div = document.getElementById('dynamicArgs');
            div.innerHTML = '';
            if(!sig) return;
            Object.values(contractInterface.functions).forEach(f => { if(f.format() === sig) selectedFunc = f; });
            updateOutputReference(selectedFunc);
            selectedFunc.inputs.forEach((input, i) => {
                const inp = document.createElement('input');
                inp.className = "input-field arg-input";
                inp.placeholder = `${input.name||'arg'+i} (${input.type})`;
                inp.dataset.type = input.type;
                div.appendChild(inp);
            });
        }

        async function startAnalysis() {
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            document.getElementById('resultsArea').classList.add('hidden');

            try {
                await initProvider();
                const mode = document.querySelector('input[name="queryMode"]:checked').value;
                const targetAddr = document.getElementById('targetAddress').value;
                
                // Config
                const seriesElements = document.querySelectorAll('#seriesContainer > div');
                const seriesConfig = [];
                seriesElements.forEach(el => {
                    const id = el.id.split('-')[1];
                    const name = document.getElementById(`name-series-${id}`).value;
                    const expr = document.getElementById(`expr-series-${id}`).value;
                    const visible = document.getElementById(`chk-series-${id}`).checked;
                    const color = el.querySelector('.rounded-full').style.backgroundColor; 
                    if(expr.trim()) seriesConfig.push({ id, name, expr, visible, color });
                });
                if(seriesConfig.length === 0) throw new Error("è¯·è‡³å°‘æ·»åŠ ä¸€æ¡è¾“å‡ºæ›²çº¿é…ç½®");

                // Call Data
                let callData = null;
                if (mode === 'manual' || mode === 'etherscan') {
                    const args = Array.from(document.querySelectorAll('.arg-input')).map(i => {
                        return i.dataset.type.includes('[]') ? i.value.split(',') : i.value;
                    });
                    callData = contractInterface.encodeFunctionData(selectedFunc, args);
                } else if (mode === 'hex') {
                    callData = document.getElementById('hexInput').value.trim();
                }

                // Time
                const startTs = new Date(document.getElementById('startTime').value).getTime() / 1000;
                const endTs = new Date(document.getElementById('endTime').value).getTime() / 1000;
                const step = parseInt(document.getElementById('stepValue').value) * parseInt(document.getElementById('stepUnit').value);
                const pointsCount = (endTs - startTs) / step;
                if (pointsCount > 300 && !confirm(`æŸ¥è¯¢ ${Math.floor(pointsCount)} ä¸ªç‚¹å¯èƒ½è¾ƒæ…¢ï¼Œç»§ç»­ï¼Ÿ`)) return;

                log("ä¼°ç®—å†å²åŒºå—...");
                const currBlock = await provider.getBlock('latest');
                const lookbackNum = Math.max(0, currBlock.number - 5000); 
                const prevBlock = await provider.getBlock(lookbackNum);
                const avgTime = (currBlock.timestamp - prevBlock.timestamp) / (currBlock.number - prevBlock.number);

                const points = [];
                for(let t = startTs; t <= endTs; t += step) points.push(t);

                // Exec
                const results = [];
                const delay = parseInt(document.getElementById('rpcDelay').value);
                document.getElementById('resultsArea').classList.remove('hidden');
                
                // Header
                const thead = document.getElementById('tableHead');
                let headHtml = `<tr><th class="p-3 col-time">Time</th><th class="p-3 col-block">Block</th>`;
                seriesConfig.forEach(s => {
                    if(s.visible) headHtml += `<th class="p-3 text-right col-val" style="color:${s.color}">${s.name}</th>`;
                });
                headHtml += `</tr>`;
                thead.innerHTML = headHtml;

                const tbody = document.getElementById('resultTableBody');
                tbody.innerHTML = '';

                for(let i=0; i<points.length; i++) {
                    const ts = points[i];
                    let blockNum = Math.floor(currBlock.number - ((currBlock.timestamp - ts) / avgTime));
                    if(blockNum < 0) blockNum = 0; if(blockNum > currBlock.number) blockNum = currBlock.number;

                    btn.innerText = `è¿›åº¦: ${Math.round((i/points.length)*100)}%`;
                    
                    const rowResult = { t: ts, block: blockNum, values: {} };
                    let tableRowHtml = `<tr><td class="p-3 font-mono text-slate-400">${moment.unix(ts).format("MM-DD HH:mm")}</td><td class="p-3 font-mono text-xs text-slate-500">#${blockNum}</td>`;

                    try {
                        let rawData;
                        if (mode === 'native') {
                            rawData = await provider.getBalance(targetAddr, blockNum);
                        } else {
                            const res = await provider.call({ to: targetAddr, data: callData }, blockNum);
                            if (mode === 'hex') {
                                try { rawData = ethers.BigNumber.from(res); } catch { rawData = 0; }
                            } else {
                                rawData = contractInterface.decodeFunctionResult(selectedFunc, res);
                            }
                        }

                        seriesConfig.forEach(s => {
                            if(!s.visible) return;
                            let val;
                            try {
                                const func = new Function('data', 'ethers', `try { return ${s.expr}; } catch(e) { return NaN; }`);
                                val = func(rawData, ethers);
                            } catch(e) { val = NaN; }
                            
                            rowResult.values[s.id] = val; 
                            
                            // æ™ºèƒ½æ˜¾ç¤ºé€»è¾‘
                            let displayHtml = '';
                            let textColor = 'text-slate-200';

                            if (typeof val === 'number') {
                                if (isNaN(val)) { displayHtml = 'Err'; textColor='text-red-500'; }
                                else { displayHtml = val.toLocaleString(undefined, {maximumFractionDigits: 6}); textColor='text-green-400'; }
                            } else if (typeof val === 'boolean') {
                                displayHtml = val ? 'TRUE' : 'FALSE'; textColor='text-blue-400';
                            } else if (typeof val === 'string') {
                                displayHtml = val; textColor='text-yellow-300'; // Addresses, Strings
                            } else if (val && val._isBigNumber) {
                                displayHtml = val.toString(); textColor='text-green-300'; // Raw BigNumbers
                            } else {
                                try { displayHtml = JSON.stringify(val); } catch { displayHtml = 'Obj'; }
                            }

                            tableRowHtml += `<td class="p-3 text-right font-mono text-xs ${textColor}">${displayHtml}</td>`;
                        });

                    } catch(e) {}

                    tableRowHtml += `</tr>`;
                    if(results.length < 50) tbody.insertAdjacentHTML('afterbegin', tableRowHtml);
                    results.push(rowResult);
                    if(delay > 0) await new Promise(r=>setTimeout(r, delay));
                }

                renderChart(results, seriesConfig);
                log(`å®Œæˆï¼`, 'success');

            } catch(e) { log(e.message, 'error'); console.error(e); } 
            finally { btn.disabled = false; btn.innerText = "ğŸš€ å¼€å§‹åˆ†æ"; }
        }

        function renderChart(data, config) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();

            const labels = data.map(d => moment.unix(d.t).format("MM-DD HH:mm"));
            const datasets = [];

            config.forEach(s => {
                if(!s.visible) return;
                // ä»…ç­›é€‰æ•°å­—ç±»å‹è¿›å…¥å›¾è¡¨
                const seriesData = data.map(d => {
                    const v = d.values[s.id];
                    return (typeof v === 'number' && !isNaN(v)) ? v : NaN;
                });
                
                // å¦‚æœå…¨æ˜¯ NaNï¼Œè¯´æ˜è¯¥åˆ—å¯èƒ½æ˜¯å­—ç¬¦ä¸²/åœ°å€ï¼Œä¸ç»˜å›¾ä½†ä¿ç•™ Legend
                datasets.push({
                    label: s.name,
                    data: seriesData,
                    borderColor: s.color,
                    backgroundColor: s.color + '20',
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 2,
                    spanGaps: true
                });
            });

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#64748b' } },
                        y: { grid: { color: '#334155' }, ticks: { color: '#64748b' } }
                    }
                }
            });
        }
    </script>
</body>
</html>